#!/bin/bash
# Quick update and deploy script for Minecraft Admin Panel
# Copy this file to update-and-deploy.sh and customize for your environment

set -e

DOCKER_BIN="/Applications/Docker.app/Contents/Resources/bin/docker"
QNAP_HOST="192.168.1.100"  # Change to your QNAP/server IP
QNAP_USER="your-username"   # Change to your SSH username
SSH_KEY="$HOME/.ssh/minecraft_panel_rsa"  # Change to your SSH key path

echo "=== Minecraft Admin Panel - Update & Deploy ==="
echo ""

# 1. Build image locally on Mac
echo "üì¶ Building Docker image..."
$DOCKER_BIN build --platform linux/amd64 -t minecraft-rcon-panel:latest .

echo ""
echo "üì° Transferring image to QNAP..."
$DOCKER_BIN save minecraft-rcon-panel:latest | \
  ssh -i "$SSH_KEY" "$QNAP_USER@$QNAP_HOST" '/share/CACHEDEV1_DATA/.qpkg/container-station/bin/docker load'

echo ""
echo "üîÑ Restarting container..."
ssh -i "$SSH_KEY" "$QNAP_USER@$QNAP_HOST" << 'ENDSSH'
# Stop and remove old container
/share/CACHEDEV1_DATA/.qpkg/container-station/bin/docker stop minecraft-rcon-panel 2>/dev/null || true
/share/CACHEDEV1_DATA/.qpkg/container-station/bin/docker rm minecraft-rcon-panel 2>/dev/null || true

# Start new container with port mapping
/share/CACHEDEV1_DATA/.qpkg/container-station/bin/docker run -d \
  --name minecraft-rcon-panel \
  --restart unless-stopped \
  -e ADMIN_USER="admin" \
  -e ADMIN_PASS="your-secure-password" \
  -e SECRET_KEY="your-secret-key-change-this" \
  -v /var/run/docker.sock:/var/run/docker.sock:ro \
  -v /path/to/.ssh/minecraft_panel_rsa:/root/.ssh/minecraft_panel_rsa:ro \
  -v /path/to/.ssh/minecraft_panel_rsa.pub:/root/.ssh/minecraft_panel_rsa.pub:ro \
  -v /path/to/data:/app/data \
  -v /path/to/templates:/app/templates \
  -v /path/to/static:/app/static \
  -p 41114:5000 \
  minecraft-rcon-panel:latest

echo ""
echo "Waiting for container to start..."
sleep 3

echo ""
echo "Container status:"
/share/CACHEDEV1_DATA/.qpkg/container-station/bin/docker ps | grep minecraft-rcon-panel || echo "‚ùå Container not running!"
ENDSSH

echo ""
echo "‚úÖ Deployment complete!"
echo ""
echo "üéÆ Access your admin panel at: http://$QNAP_HOST:41114"
echo ""
echo "üìã View logs:"
echo "   ssh -i $SSH_KEY $QNAP_USER@$QNAP_HOST '/share/CACHEDEV1_DATA/.qpkg/container-station/bin/docker logs -f minecraft-rcon-panel'"
echo ""
