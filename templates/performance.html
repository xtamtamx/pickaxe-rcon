{% extends "base.html" %}

{% block extra_css %}
<style>
.perf-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 30px;
}

.charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

@media (max-width: 768px) {
    .perf-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 20px;
    }

    .perf-grid .mc-panel-body {
        padding: 12px !important;
    }

    .perf-grid .mc-panel-body > div:first-child {
        font-size: 12px !important;
        margin-bottom: 4px !important;
    }

    .perf-grid .mc-panel-body > div:nth-child(2) {
        font-size: 24px !important;
    }

    .perf-grid .mc-panel-body > div:last-child {
        font-size: 10px !important;
    }

    .charts-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .charts-grid canvas {
        max-width: 100%;
        height: auto !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto;">
    <h1 style="color: #7cbd1e; margin-bottom: 20px;">ðŸ“Š Server Performance</h1>

    <!-- Current Stats Cards -->
    <div class="perf-grid">
        <div class="mc-panel">
            <div class="mc-panel-body" style="text-align: center;">
                <div style="color: #7cbd1e; font-size: 14px; margin-bottom: 8px;">CPU Usage</div>
                <div id="cpu-current" style="font-size: 36px; font-weight: bold; color: #fff;">--</div>
                <div style="color: #aaa; font-size: 12px;">Percent</div>
            </div>
        </div>

        <div class="mc-panel">
            <div class="mc-panel-body" style="text-align: center;">
                <div style="color: #7cbd1e; font-size: 14px; margin-bottom: 8px;">Memory</div>
                <div id="mem-current" style="font-size: 36px; font-weight: bold; color: #fff;">--</div>
                <div style="color: #aaa; font-size: 12px;">Percent</div>
            </div>
        </div>

        <div class="mc-panel">
            <div class="mc-panel-body" style="text-align: center;">
                <div style="color: #7cbd1e; font-size: 14px; margin-bottom: 8px;">Network I/O</div>
                <div id="net-current" style="font-size: 18px; font-weight: bold; color: #fff;">--</div>
                <div style="color: #aaa; font-size: 12px;">RX / TX</div>
            </div>
        </div>

        <div class="mc-panel">
            <div class="mc-panel-body" style="text-align: center;">
                <div style="color: #7cbd1e; font-size: 14px; margin-bottom: 8px;">Disk I/O</div>
                <div id="disk-current" style="font-size: 18px; font-weight: bold; color: #fff;">--</div>
                <div style="color: #aaa; font-size: 12px;">Read / Write</div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
        <div class="mc-panel">
            <div class="mc-panel-header">
                ðŸ“ˆ CPU Usage History
            </div>
            <div class="mc-panel-body">
                <canvas id="cpuChart" width="400" height="200"></canvas>
            </div>
        </div>

        <div class="mc-panel">
            <div class="mc-panel-header">
                ðŸ’¾ Memory Usage History
            </div>
            <div class="mc-panel-body">
                <canvas id="memChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Detailed Stats -->
    <div class="mc-panel" style="margin-top: 20px;">
        <div class="mc-panel-header">
            ðŸ“‹ Detailed Statistics
        </div>
        <div class="mc-panel-body">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                    <strong style="color: #7cbd1e;">Memory Usage:</strong>
                    <p id="mem-details" style="color: #ddd; margin: 4px 0;">Loading...</p>
                </div>
                <div>
                    <strong style="color: #7cbd1e;">Network I/O:</strong>
                    <p id="net-details" style="color: #ddd; margin: 4px 0;">Loading...</p>
                </div>
                <div>
                    <strong style="color: #7cbd1e;">Disk I/O:</strong>
                    <p id="disk-details" style="color: #ddd; margin: 4px 0;">Loading...</p>
                </div>
                <div>
                    <strong style="color: #7cbd1e;">Container Status:</strong>
                    <p id="container-status" style="color: #ddd; margin: 4px 0;">Running</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Data storage for charts
const maxDataPoints = 60; // Keep last 60 readings
const cpuData = [];
const memData = [];
const labels = [];

// Create charts
const cpuCtx = document.getElementById('cpuChart').getContext('2d');
const cpuChart = new Chart(cpuCtx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'CPU %',
            data: cpuData,
            borderColor: '#7cbd1e',
            backgroundColor: 'rgba(124, 189, 30, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: { color: '#aaa' },
                grid: { color: '#555' }
            },
            x: {
                ticks: { color: '#aaa' },
                grid: { color: '#555' }
            }
        },
        plugins: {
            legend: { labels: { color: '#fff' } }
        }
    }
});

const memCtx = document.getElementById('memChart').getContext('2d');
const memChart = new Chart(memCtx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Memory %',
            data: memData,
            borderColor: '#5dade2',
            backgroundColor: 'rgba(93, 173, 226, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 100,
                ticks: { color: '#aaa' },
                grid: { color: '#555' }
            },
            x: {
                ticks: { color: '#aaa' },
                grid: { color: '#555' }
            }
        },
        plugins: {
            legend: { labels: { color: '#fff' } }
        }
    }
});

function updateStats() {
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update current stats
                document.getElementById('cpu-current').textContent = data.cpu_percent.toFixed(1) + '%';
                document.getElementById('mem-current').textContent = data.memory_percent.toFixed(1) + '%';
                document.getElementById('net-current').textContent = data.network_io;
                document.getElementById('disk-current').textContent = data.block_io;

                // Update detailed stats
                document.getElementById('mem-details').textContent = `${data.memory_used} / ${data.memory_limit} (${data.memory_percent.toFixed(1)}%)`;
                document.getElementById('net-details').textContent = data.network_io;
                document.getElementById('disk-details').textContent = data.block_io;

                // Add data to charts
                const now = new Date();
                const timeLabel = now.toLocaleTimeString();

                cpuData.push(data.cpu_percent);
                memData.push(data.memory_percent);
                labels.push(timeLabel);

                // Keep only last N data points
                if (cpuData.length > maxDataPoints) {
                    cpuData.shift();
                    memData.shift();
                    labels.shift();
                }

                // Update charts
                cpuChart.update();
                memChart.update();

                // Color code CPU based on usage
                const cpuEl = document.getElementById('cpu-current');
                if (data.cpu_percent > 80) {
                    cpuEl.style.color = '#ff5555';
                } else if (data.cpu_percent > 50) {
                    cpuEl.style.color = '#ffaa00';
                } else {
                    cpuEl.style.color = '#7cbd1e';
                }

                // Color code memory
                const memEl = document.getElementById('mem-current');
                if (data.memory_percent > 80) {
                    memEl.style.color = '#ff5555';
                } else if (data.memory_percent > 50) {
                    memEl.style.color = '#ffaa00';
                } else {
                    memEl.style.color = '#7cbd1e';
                }
            }
        })
        .catch(error => {
            console.error('Failed to fetch stats:', error);
        });
}

// Update stats every 2 seconds
updateStats();
setInterval(updateStats, 2000);
</script>
{% endblock %}
