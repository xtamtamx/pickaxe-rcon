{% extends "base.html" %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto;">
    <!-- Online Players -->
    <div class="mc-panel" style="margin-bottom: 20px;">
        <div class="mc-panel-header">
            ğŸ‘¥ Online Players
        </div>
        <div class="mc-panel-body">
            <div id="player-list" style="background: #1a1a1a; padding: 16px; border-radius: 4px; min-height: 100px;">
                <p style="color: #aaa; text-align: center; margin: 0;">Loading...</p>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
                <button class="mc-button mc-button-blue" onclick="refreshMap()">
                    ğŸ”„ Refresh Players
                </button>
                <p style="color: #aaa; font-size: 12px; margin: 0;">
                    â„¹ï¸ Bedrock Edition doesn't support position tracking via RCON
                </p>
            </div>
        </div>
    </div>

    <!-- uNmINeD World Map -->
    <div class="mc-panel" style="margin-bottom: 20px;">
        <div class="mc-panel-header">
            ğŸ—ºï¸ uNmINeD World Map
        </div>
        <div class="mc-panel-body">
            <div style="display: flex; gap: 12px; margin-bottom: 16px; align-items: center; flex-wrap: wrap;">
                <button class="mc-button mc-button-green" onclick="loadMap()">
                    ğŸ—ºï¸ Load Map
                </button>
                <button class="mc-button mc-button-blue" onclick="openMapNewTab()">
                    ğŸ”— Open in New Tab
                </button>
                <button class="mc-button" onclick="closeMap()">
                    âœ–ï¸ Close Map
                </button>
                <div style="flex: 1; text-align: right;">
                    <span style="color: #7cbd1e; font-size: 14px;">ğŸ“ Map Server: {{ map_url or 'Not configured' }}</span>
                </div>
            </div>
            <div id="map-container" style="display: none; height: 800px; border: 2px solid #7cbd1e; border-radius: 4px; overflow: hidden; background: #1a1a1a; position: relative;">
                <iframe id="map-iframe" style="width: 100%; height: calc(100% + 80px); border: none; position: absolute; top: -40px; left: 0;"></iframe>
            </div>
            <div id="map-placeholder" style="height: 400px; border: 2px dashed #555; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: #1a1a1a;">
                <div style="text-align: center; color: #aaa;">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ—ºï¸</div>
                    <p style="margin: 0; font-size: 18px;">Click "Load Map" to view your world</p>
                    <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">Interactive 2D map with biomes and structures</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chunkbase Seed Map -->
    <div class="mc-panel" style="margin-bottom: 20px;">
        <div class="mc-panel-header">
            ğŸŒ Chunkbase Seed Map
        </div>
        <div class="mc-panel-body">
            <div style="padding: 16px; background: #1a1a1a; border-radius: 4px;">
                <p style="color: #ddd; margin-bottom: 12px; line-height: 1.6;">
                    Use Chunkbase to explore predicted terrain, biomes, and structure locations based on your world seed.
                </p>
                <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                    <button class="mc-button mc-button-blue" onclick="openChunkbase()">
                        ğŸ” Open Chunkbase
                    </button>
                    <button class="mc-button" onclick="copyWorldSeed()">
                        ğŸ“‹ Copy World Seed
                    </button>
                    <span style="color: #888; font-size: 14px;">
                        Seed: <span id="seed-display" style="color: #7cbd1e; font-family: monospace;">Loading...</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Current World Info -->
    <div class="mc-panel" style="margin-bottom: 20px;">
        <div class="mc-panel-header">
            ğŸŒ Current World Info
        </div>
        <div class="mc-panel-body">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <strong style="color: #7cbd1e;">World Name:</strong>
                    <p id="world-name" style="font-size: 20px; margin: 4px 0;">Loading...</p>
                </div>
                <div>
                    <strong style="color: #7cbd1e;">Current Seed:</strong>
                    <p id="world-seed" style="font-size: 20px; margin: 4px 0; font-family: monospace;">Loading...</p>
                    <button class="mc-button mc-button-blue" onclick="checkSeed()" style="margin-top: 8px;">
                        ğŸ” Check Seed
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <!-- Create Backup -->
        <div class="mc-panel">
            <div class="mc-panel-header">
                ğŸ’¾ Create Backup
            </div>
            <div class="mc-panel-body">
                <p style="margin-bottom: 12px;">Create a backup of your current world before making changes.</p>
                <input type="text" id="backup-name" class="mc-input" placeholder="Backup name (optional)" style="margin-bottom: 12px;">
                <button class="mc-button mc-button-green" onclick="createBackup()" style="width: 100%;">
                    ğŸ’¾ Create Backup Now
                </button>
            </div>
        </div>

        <!-- Start New World -->
        <div class="mc-panel">
            <div class="mc-panel-header">
                ğŸŒ Start New World
            </div>
            <div class="mc-panel-body">
                <p style="margin-bottom: 12px; color: #ff5555;"><strong>âš ï¸ Warning:</strong> This deletes your current world!</p>
                <input type="text" id="new-world-seed" class="mc-input" placeholder="World seed (optional)" style="margin-bottom: 12px;">
                <button class="mc-button mc-button-red" onclick="confirmNewWorld()" style="width: 100%;">
                    ğŸ—‘ï¸ Delete World & Start New
                </button>
            </div>
        </div>
    </div>

    <!-- Backups List -->
    <div class="mc-panel">
        <div class="mc-panel-header">
            ğŸ“¦ World Backups
        </div>
        <div class="mc-panel-body">
            <div id="backups-loading" style="text-align: center; padding: 20px;">
                <p>Loading backups...</p>
            </div>

            <div id="backups-container" style="display: none;">
                <table class="mc-table">
                    <thead>
                        <tr>
                            <th>Backup Name</th>
                            <th>Size</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="backups-body">
                    </tbody>
                </table>
            </div>

            <div id="message" style="margin-top: 16px; padding: 12px; display: none; border-radius: 4px;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
.mc-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
}

.mc-table th {
    background-color: #555;
    color: #7cbd1e;
    padding: 12px;
    text-align: left;
    font-size: 20px;
    text-shadow: 2px 2px 0 #000;
}

.mc-table td {
    padding: 12px;
    border-bottom: 2px solid #555;
    font-size: 18px;
}

.mc-table tbody tr:hover {
    background-color: rgba(124, 203, 30, 0.1);
}
</style>

<script>
// Initialize and auto-refresh players
window.addEventListener('DOMContentLoaded', function() {
    refreshMap();
    setInterval(refreshMap, 10000); // Auto-refresh every 10 seconds
});

function refreshMap() {
    fetch('/api/players')
        .then(response => response.json())
        .then(data => {
            const playerListDiv = document.getElementById('player-list');

            if (data.success && data.players && data.players.length > 0) {
                let html = '<div style="display: grid; gap: 8px;">';

                data.players.forEach(player => {
                    html += `
                        <div style="padding: 12px; background: #2a2a2a; border-radius: 4px; border-left: 3px solid #7cbd1e; display: flex; align-items: center;">
                            <span style="font-size: 20px; margin-right: 12px;">ğŸ‘¤</span>
                            <span style="color: #fff; font-size: 18px;">${player}</span>
                        </div>
                    `;
                });

                html += '</div>';
                playerListDiv.innerHTML = html;
            } else {
                playerListDiv.innerHTML = '<p style="color: #aaa; text-align: center; margin: 0;">No players online</p>';
            }
        })
        .catch(error => {
            document.getElementById('player-list').innerHTML = '<p style="color: #ff5555; text-align: center; margin: 0;">Error loading players</p>';
        });
}

function loadMap() {
    const mapContainer = document.getElementById('map-container');
    const mapPlaceholder = document.getElementById('map-placeholder');
    const mapIframe = document.getElementById('map-iframe');
    const mapUrl = '{{ map_url }}';

    if (!mapUrl) {
        showMessage('âŒ Map server URL not configured. Please set it in Connection Settings.', false);
        return;
    }

    mapIframe.src = mapUrl;
    mapContainer.style.display = 'block';
    mapPlaceholder.style.display = 'none';

    showMessage('âœ“ Loading map...', true);
}

function openMapNewTab() {
    const mapUrl = '{{ map_url }}';

    if (!mapUrl) {
        showMessage('âŒ Map server URL not configured. Please set it in Connection Settings.', false);
        return;
    }

    window.open(mapUrl, '_blank');
    showMessage('âœ“ Opening map in new tab...', true);
}

function closeMap() {
    const mapContainer = document.getElementById('map-container');
    const mapPlaceholder = document.getElementById('map-placeholder');
    const mapIframe = document.getElementById('map-iframe');

    mapContainer.style.display = 'none';
    mapPlaceholder.style.display = 'flex';
    mapIframe.src = 'about:blank';
}

function openChunkbase() {
    window.open('https://www.chunkbase.com/apps/seed-map#bedrock', '_blank');
    showMessage('âœ“ Opening Chunkbase... Paste your world seed there!', true);
}

function copyWorldSeed() {
    const seedDisplay = document.getElementById('seed-display');
    const seed = seedDisplay.textContent;

    if (seed && seed !== 'Loading...' && seed !== 'Unknown') {
        navigator.clipboard.writeText(seed).then(() => {
            showMessage(`âœ“ Copied seed to clipboard: ${seed}`, true);
        }).catch(() => {
            showMessage(`World seed: ${seed}`, true);
        });
    } else {
        showMessage('Click "Check Seed" button in World Info section first', false);
    }
}

// Update seed display when world info loads
function updateSeedDisplay() {
    const worldSeed = document.getElementById('world-seed');
    const seedDisplay = document.getElementById('seed-display');

    if (worldSeed && seedDisplay) {
        const observer = new MutationObserver(() => {
            seedDisplay.textContent = worldSeed.textContent;
        });

        observer.observe(worldSeed, { childList: true, characterData: true, subtree: true });

        // Initial sync
        seedDisplay.textContent = worldSeed.textContent;
    }
}

function loadBackups() {
    document.getElementById('backups-loading').style.display = 'block';
    document.getElementById('backups-container').style.display = 'none';

    fetch('/api/backups')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayBackups(data.backups);
                document.getElementById('backups-loading').style.display = 'none';
                document.getElementById('backups-container').style.display = 'block';
            } else {
                showMessage('Failed to load backups: ' + data.error, false);
            }
        })
        .catch(error => {
            showMessage('Error loading backups: ' + error, false);
        });
}

function displayBackups(backups) {
    const tbody = document.getElementById('backups-body');
    tbody.innerHTML = '';

    if (!backups || backups.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #aaa;">No backups found</td></tr>';
        return;
    }

    backups.forEach(backup => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${backup.filename}</td>
            <td>${backup.size} bytes</td>
            <td>${backup.date}</td>
            <td>
                <button class="mc-button mc-button-blue" onclick="restoreBackup('${backup.filename}')" style="margin-right: 8px;">
                    â™»ï¸ Restore
                </button>
                <button class="mc-button mc-button-red" onclick="deleteBackup('${backup.filename}')">
                    ğŸ—‘ï¸ Delete
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function createBackup() {
    const backupName = document.getElementById('backup-name').value.trim();

    showMessage('Creating backup...', true);

    fetch('/api/backup/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: backupName || null })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('âœ“ ' + data.message, true);
            document.getElementById('backup-name').value = '';
            setTimeout(loadBackups, 1000);
        } else {
            showMessage('âœ— Failed to create backup: ' + data.error, false);
        }
    });
}

function restoreBackup(filename) {
    if (!confirm(`Restore world from backup: ${filename}?\n\nThis will:\n1. Delete your current world\n2. Restore from this backup\n3. Require a server restart\n\nAre you sure?`)) {
        return;
    }

    showMessage('Restoring backup...', true);

    fetch('/api/backup/restore', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: filename })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('âœ“ ' + data.message, true);
        } else {
            showMessage('âœ— Failed to restore: ' + data.error, false);
        }
    });
}

function deleteBackup(filename) {
    if (!confirm(`Delete backup: ${filename}?\n\nThis cannot be undone!`)) {
        return;
    }

    fetch('/api/backup/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: filename })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('âœ“ ' + data.message, true);
            setTimeout(loadBackups, 500);
        } else {
            showMessage('âœ— Failed to delete: ' + data.error, false);
        }
    });
}

function confirmNewWorld() {
    const seed = document.getElementById('new-world-seed').value.trim();

    const message = seed
        ? `Start a NEW WORLD with seed: ${seed}?\n\nâš ï¸ WARNING âš ï¸\nThis will PERMANENTLY DELETE your current world!\n\nMake sure you have a backup!\n\nAre you absolutely sure?`
        : `Start a NEW WORLD with random seed?\n\nâš ï¸ WARNING âš ï¸\nThis will PERMANENTLY DELETE your current world!\n\nMake sure you have a backup!\n\nAre you absolutely sure?`;

    if (!confirm(message)) {
        return;
    }

    // Double confirm
    if (!confirm('This is your last chance!\n\nClick OK to DELETE the current world and start fresh.')) {
        return;
    }

    createNewWorld(seed);
}

function createNewWorld(seed) {
    showMessage('Deleting current world...', true);

    fetch('/api/world/new', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ seed: seed || null })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('âœ“ ' + data.message + '\n\nRestart the server to generate the new world!', true);
            document.getElementById('new-world-seed').value = '';
        } else {
            showMessage('âœ— Failed: ' + data.error, false);
        }
    });
}

function showMessage(msg, success) {
    const msgDiv = document.getElementById('message');
    msgDiv.style.display = 'block';
    msgDiv.style.backgroundColor = success ? '#7cbd1e' : '#ff5555';
    msgDiv.style.color = success ? '#000' : '#fff';
    msgDiv.style.whiteSpace = 'pre-line';
    msgDiv.textContent = msg;

    setTimeout(() => {
        if (msgDiv.style.display === 'block') {
            msgDiv.style.display = 'none';
        }
    }, 8000);
}

function loadWorldInfo() {
    // Load world name from server properties
    fetch('/api/server-properties')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const worldName = data.properties['level-name'] || 'Unknown';
                document.getElementById('world-name').textContent = worldName;

                // Also load seed from properties
                const propertySeed = data.properties['level-seed'] || 'Not set';
                document.getElementById('world-seed').textContent = propertySeed;
            }
        })
        .catch(error => {
            document.getElementById('world-name').textContent = 'Error loading';
            document.getElementById('world-seed').textContent = 'Error loading';
        });
}

function checkSeed() {
    // Execute /seed command to get the actual world seed
    fetch('/api/send-command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ command: 'seed' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Parse the seed from response (format: "Seed: [1234567890]")
            const seedMatch = data.output.match(/Seed:\s*\[?(-?\d+)\]?/i);
            if (seedMatch) {
                const actualSeed = seedMatch[1];
                document.getElementById('world-seed').textContent = actualSeed;
                showMessage('âœ“ Current world seed: ' + actualSeed, true);
            } else {
                showMessage('Could not parse seed from: ' + data.output, false);
            }
        } else {
            showMessage('âœ— Failed to get seed: ' + data.error, false);
        }
    })
    .catch(error => {
        showMessage('âœ— Error: ' + error, false);
    });
}

// Load world info and backups on page load
loadWorldInfo();
loadBackups();
updateSeedDisplay();
</script>
{% endblock %}
