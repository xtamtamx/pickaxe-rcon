{% extends "base.html" %}

{% block content %}
<div style="max-width: 1100px; margin: 0 auto;">
    <div class="mc-grid mc-grid-2col">
        <!-- Online Players -->
        <div class="mc-panel">
            <div class="mc-panel-header">
                ğŸ‘¥ Online Players
            </div>
            <div class="mc-panel-body">
                <div id="online-players">
                    <p style="text-align: center; color: #aaa;">Loading...</p>
                </div>
                <button class="mc-button" onclick="loadOnlinePlayers()" style="width: 100%; margin-top: 12px;">
                    ğŸ”„ Refresh
                </button>
            </div>
        </div>

        <!-- Operators -->
        <div class="mc-panel">
            <div class="mc-panel-header">
                ğŸ‘‘ Server Operators
            </div>
            <div class="mc-panel-body">
                <div id="ops-list">
                    <p style="text-align: center; color: #aaa;">Loading...</p>
                </div>
                <button class="mc-button" onclick="loadOps()" style="width: 100%; margin-top: 12px;">
                    ğŸ”„ Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Welcome Kit -->
    <div class="mc-panel">
        <div class="mc-panel-header">
            ğŸ New Player Welcome Kit
            <span id="kit-status-badge" style="float: right; padding: 4px 12px; border-radius: 4px; font-size: 14px; background: #555; color: #aaa;">Loading...</span>
        </div>
        <div class="mc-panel-body">
            <p style="margin-bottom: 12px; color: #ddd;">Give new players a starter kit when they first join. Select items to include:</p>

            <!-- Selected Items Section -->
            <div id="selected-items-section" style="margin-bottom: 16px;">
                <h4 style="margin: 0 0 8px 0; color: #7cbd1e; font-size: 16px;">âœ“ Selected Items</h4>
                <div id="selected-items-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px; min-height: 50px; padding: 12px; background: rgba(124, 189, 30, 0.1); border-radius: 4px; border: 2px solid #7cbd1e;">
                    <!-- Selected items will appear here dynamically -->
                </div>
            </div>

            <!-- Map Configuration (only shown when map is checked) -->
            <div id="map-config" style="margin-bottom: 16px; padding: 12px; background: #333; border-radius: 4px; border: 2px solid #7cbd1e;">
                <h4 style="margin: 0 0 12px 0; color: #7cbd1e;">ğŸ—ºï¸ Map Configuration</h4>
                <div style="display: grid; gap: 12px;">
                    <div>
                        <label style="display: block; margin-bottom: 4px; color: #ddd;">Map Type:</label>
                        <select id="map-type" class="mc-input" style="width: 100%;">
                            <option value="filled_map" selected>Locator Map (shows player position)</option>
                            <option value="map">Empty Map (needs to be filled)</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 4px; color: #ddd;">Zoom Level (0 = closest, 4 = farthest):</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="range" id="map-zoom" min="0" max="4" value="0" style="flex: 1;" oninput="document.getElementById('zoom-value').textContent = this.value">
                            <span id="zoom-value" style="min-width: 30px; color: #7cbd1e; font-weight: bold;">0</span>
                        </div>
                        <small style="color: #aaa;">Level 0: 128Ã—128 blocks | Level 4: 2048Ã—2048 blocks</small>
                    </div>
                </div>
            </div>

            <!-- Available Items Section -->
            <div id="available-items-section">
                <h4 style="margin: 0 0 8px 0; color: #aaa; font-size: 16px;">Available Items</h4>
                <div id="available-items-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                    <!-- All items start here -->
                    <label class="kit-item-label" style="display: flex; align-items: center; padding: 8px; background: #2a2a2a; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="kit-map" checked style="margin-right: 8px;" onchange="updateItemSections()">
                        <span>ğŸ—ºï¸ Map</span>
                    </label>
                    <label class="kit-item-label" style="display: flex; align-items: center; padding: 8px; background: #2a2a2a; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="kit-compass" checked style="margin-right: 8px;" onchange="updateItemSections()">
                        <span>ğŸ§­ Compass</span>
                    </label>
                    <label class="kit-item-label" style="display: flex; align-items: center; padding: 8px; background: #2a2a2a; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="kit-bread" style="margin-right: 8px;" onchange="updateItemSections()">
                        <span>ğŸ Bread (10)</span>
                    </label>
                    <label class="kit-item-label" style="display: flex; align-items: center; padding: 8px; background: #2a2a2a; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="kit-wooden-pickaxe" style="margin-right: 8px;" onchange="updateItemSections()">
                        <span>â›ï¸ Wooden Pickaxe</span>
                    </label>
                    <label class="kit-item-label" style="display: flex; align-items: center; padding: 8px; background: #2a2a2a; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="kit-torch" style="margin-right: 8px;" onchange="updateItemSections()">
                        <span>ğŸ”¦ Torch (16)</span>
                    </label>
                    <label class="kit-item-label" style="display: flex; align-items: center; padding: 8px; background: #2a2a2a; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="kit-apple" style="margin-right: 8px;" onchange="updateItemSections()">
                        <span>ğŸ Apple (5)</span>
                    </label>
                    <label class="kit-item-label" style="display: flex; align-items: center; padding: 8px; background: #2a2a2a; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="kit-wooden-axe" style="margin-right: 8px;" onchange="updateItemSections()">
                        <span>ğŸª“ Wooden Axe</span>
                    </label>
                    <label class="kit-item-label" style="display: flex; align-items: center; padding: 8px; background: #2a2a2a; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="kit-wooden-sword" style="margin-right: 8px;" onchange="updateItemSections()">
                        <span>âš”ï¸ Wooden Sword</span>
                    </label>
                    <label class="kit-item-label" style="display: flex; align-items: center; padding: 8px; background: #2a2a2a; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="kit-oak-log" style="margin-right: 8px;" onchange="updateItemSections()">
                        <span>ğŸªµ Oak Log (16)</span>
                    </label>
                    <label class="kit-item-label" style="display: flex; align-items: center; padding: 8px; background: #2a2a2a; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="kit-cobblestone" style="margin-right: 8px;" onchange="updateItemSections()">
                        <span>ğŸª¨ Cobblestone (32)</span>
                    </label>
                    <label class="kit-item-label" style="display: flex; align-items: center; padding: 8px; background: #2a2a2a; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="kit-bed" style="margin-right: 8px;" onchange="updateItemSections()">
                        <span>ğŸ›ï¸ Bed</span>
                    </label>
                    <label class="kit-item-label" style="display: flex; align-items: center; padding: 8px; background: #2a2a2a; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="kit-crafting-table" style="margin-right: 8px;" onchange="updateItemSections()">
                        <span>ğŸ“¦ Crafting Table</span>
                    </label>
                    <label class="kit-item-label" style="display: flex; align-items: center; padding: 8px; background: #2a2a2a; border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="kit-chest" style="margin-right: 8px;" onchange="updateItemSections()">
                        <span>ğŸ“¦ Chest</span>
                    </label>
                </div>
            </div>

            <div style="display: flex; gap: 8px;">
                <button class="mc-button mc-button-green" onclick="setupWelcomeKit()" style="flex: 1;">
                    âœ“ Enable Welcome Kit
                </button>
                <button class="mc-button mc-button-red" onclick="disableWelcomeKit()" style="flex: 1;">
                    âœ— Disable Welcome Kit
                </button>
            </div>

            <div id="welcome-kit-status" style="margin-top: 12px; padding: 8px; border-radius: 4px; display: none;"></div>
        </div>
    </div>

    <!-- Player Actions -->
    <div class="mc-panel">
        <div class="mc-panel-header">
            âš¡ Player Actions
        </div>
        <div class="mc-panel-body">
            <!-- Grant/Remove OP -->
            <div class="mc-form-group">
                <h3 style="color: #7cbd1e; margin-top: 0; margin-bottom: 12px; font-size: 18px;">Operator Status</h3>
                <div class="mc-form-inline" style="margin-bottom: 8px;">
                    <input type="text" id="op-player" class="mc-input" placeholder="Player name">
                    <button class="mc-button mc-button-green" onclick="grantOp()">
                        ğŸ‘‘ Grant OP
                    </button>
                </div>
                <div class="mc-form-inline">
                    <input type="text" id="deop-player" class="mc-input" placeholder="Player name">
                    <button class="mc-button mc-button-red" onclick="removeOp()">
                        â¬‡ï¸ Remove OP
                    </button>
                </div>
            </div>

            <!-- Kick Player -->
            <div class="mc-form-group">
                <h3 style="color: #7cbd1e; margin-top: 0; margin-bottom: 12px; font-size: 18px;">Kick Player</h3>
                <input type="text" id="kick-player" class="mc-input" placeholder="Player name" style="margin-bottom: 8px;">
                <input type="text" id="kick-reason" class="mc-input" placeholder="Reason (optional)" style="margin-bottom: 8px;">
                <button class="mc-button mc-button-red" onclick="kickPlayer()" style="width: 100%;">
                    ğŸš« Kick Player
                </button>
            </div>

            <div id="action-message" style="margin-top: 16px; padding: 12px; display: none; border-radius: 4px;"></div>
        </div>
    </div>

    <!-- Advanced Player Management -->
    <div class="mc-panel">
        <div class="mc-panel-header">
            ğŸ® Advanced Player Management
        </div>
        <div class="mc-panel-body">
            <div class="mc-grid mc-grid-2col">
                <!-- Teleport Player -->
                <div class="mc-form-group">
                    <h3 style="color: #7cbd1e; margin-top: 0; margin-bottom: 12px; font-size: 16px;">ğŸŒ Teleport Player</h3>
                    <div style="display: grid; gap: 8px;">
                        <input type="text" id="tp-player" class="mc-input" placeholder="Player name">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                            <input type="number" id="tp-x" class="mc-input" placeholder="X">
                            <input type="number" id="tp-y" class="mc-input" placeholder="Y">
                            <input type="number" id="tp-z" class="mc-input" placeholder="Z">
                        </div>
                        <button class="mc-button mc-button-blue" onclick="teleportPlayer()">
                            ğŸ“ Teleport
                        </button>
                    </div>
                </div>

                <!-- Give Item -->
                <div class="mc-form-group">
                    <h3 style="color: #7cbd1e; margin-top: 0; margin-bottom: 12px; font-size: 16px;">ğŸ Give Item</h3>
                    <div style="display: grid; gap: 8px;">
                        <input type="text" id="give-player" class="mc-input" placeholder="Player name">
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px;">
                            <input type="text" id="give-item" class="mc-input" placeholder="Item ID (e.g. diamond)">
                            <input type="number" id="give-amount" class="mc-input" placeholder="Amt" value="1" min="1" style="width: 80px;">
                        </div>
                        <button class="mc-button mc-button-green" onclick="giveItem()">
                            âœ¨ Give Item
                        </button>
                    </div>
                </div>

                <!-- Change Gamemode -->
                <div>
                    <h3 style="color: #7cbd1e; margin-top: 0; margin-bottom: 12px; font-size: 16px;">ğŸ¯ Change Gamemode</h3>
                    <div style="display: grid; gap: 8px;">
                        <input type="text" id="gamemode-player" class="mc-input" placeholder="Player name">
                        <select id="gamemode-select" class="mc-input">
                            <option value="survival">Survival</option>
                            <option value="creative">Creative</option>
                            <option value="adventure">Adventure</option>
                            <option value="spectator">Spectator</option>
                        </select>
                        <button class="mc-button mc-button-blue" onclick="changeGamemode()">
                            ğŸ”„ Change Mode
                        </button>
                    </div>
                </div>

                <!-- Effect Player -->
                <div>
                    <h3 style="color: #7cbd1e; margin-top: 0; margin-bottom: 12px; font-size: 16px;">âœ¨ Give Effect</h3>
                    <div style="display: grid; gap: 8px;">
                        <input type="text" id="effect-player" class="mc-input" placeholder="Player name">
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px;">
                            <select id="effect-type" class="mc-input">
                                <option value="speed">Speed</option>
                                <option value="slowness">Slowness</option>
                                <option value="haste">Haste</option>
                                <option value="strength">Strength</option>
                                <option value="regeneration">Regeneration</option>
                                <option value="resistance">Resistance</option>
                                <option value="fire_resistance">Fire Resistance</option>
                                <option value="water_breathing">Water Breathing</option>
                                <option value="invisibility">Invisibility</option>
                                <option value="night_vision">Night Vision</option>
                            </select>
                            <input type="number" id="effect-duration" class="mc-input" placeholder="Sec" value="30" min="1" style="width: 80px;">
                        </div>
                        <button class="mc-button mc-button-green" onclick="giveEffect()">
                            ğŸ’« Apply Effect
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function loadOnlinePlayers() {
    fetch('/api/players')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('online-players');

            if (data.success && data.players.length > 0) {
                // SECURITY: Escape player names to prevent XSS
                container.innerHTML = '<ul style="list-style: none; padding: 0; margin: 0;">' +
                    data.players.map(p => `<li style="padding: 8px; border-bottom: 1px solid #555;">ğŸ‘¤ ${escapeHtml(p)}</li>`).join('') +
                    '</ul>';
            } else {
                container.innerHTML = '<p style="text-align: center; color: #aaa;">No players online</p>';
            }
        })
        .catch(error => {
            document.getElementById('online-players').innerHTML = '<p style="color: #ff5555;">Error loading players</p>';
        });
}

function loadOps() {
    fetch('/api/ops')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('ops-list');

            if (data.success && data.ops && data.ops.length > 0) {
                // SECURITY: Escape operator names to prevent XSS
                container.innerHTML = '<ul style="list-style: none; padding: 0; margin: 0;">' +
                    data.ops.map(op => `<li style="padding: 8px; border-bottom: 1px solid #555;">ğŸ‘‘ ${escapeHtml(op.name || op.gamertag || op.xuid || 'Unknown')}</li>`).join('') +
                    '</ul>';
            } else {
                container.innerHTML = '<p style="text-align: center; color: #aaa;">No operators</p>';
            }
        })
        .catch(error => {
            document.getElementById('ops-list').innerHTML = '<p style="color: #ff5555;">Error loading operators</p>';
        });
}

function grantOp() {
    const player = document.getElementById('op-player').value.trim();
    if (!player) {
        showMessage('Please enter a player name', false);
        return;
    }

    fetch('/api/player/op', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ player: player })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(`Granted OP to ${player}`, true);
            document.getElementById('op-player').value = '';
            setTimeout(loadOps, 1000);
        } else {
            showMessage('Failed to grant OP: ' + data.error, false);
        }
    });
}

function removeOp() {
    const player = document.getElementById('deop-player').value.trim();
    if (!player) {
        showMessage('Please enter a player name', false);
        return;
    }

    fetch('/api/player/deop', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ player: player })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(`Removed OP from ${player}`, true);
            document.getElementById('deop-player').value = '';
            setTimeout(loadOps, 1000);
        } else {
            showMessage('Failed to remove OP: ' + data.error, false);
        }
    });
}

function kickPlayer() {
    const player = document.getElementById('kick-player').value.trim();
    const reason = document.getElementById('kick-reason').value.trim();

    if (!player) {
        showMessage('Please enter a player name', false);
        return;
    }

    fetch('/api/player/kick', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ player: player, reason: reason })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(`Kicked ${player}`, true);
            document.getElementById('kick-player').value = '';
            document.getElementById('kick-reason').value = '';
            setTimeout(loadOnlinePlayers, 1000);
        } else {
            showMessage('Failed to kick player: ' + data.error, false);
        }
    });
}

function showMessage(msg, success) {
    const msgDiv = document.getElementById('action-message');
    msgDiv.style.display = 'block';
    msgDiv.style.backgroundColor = success ? '#7cbd1e' : '#ff5555';
    msgDiv.style.color = success ? '#000' : '#fff';
    msgDiv.textContent = msg;

    setTimeout(() => {
        msgDiv.style.display = 'none';
    }, 5000);
}

function teleportPlayer() {
    const player = document.getElementById('tp-player').value.trim();
    const x = document.getElementById('tp-x').value;
    const y = document.getElementById('tp-y').value;
    const z = document.getElementById('tp-z').value;

    if (!player || !x || !y || !z) {
        showMessage('Please fill in all teleport fields', false);
        return;
    }

    fetch('/api/player/teleport', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ player: player, x: parseFloat(x), y: parseFloat(y), z: parseFloat(z) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(`Teleported ${player} to ${x}, ${y}, ${z}`, true);
            document.getElementById('tp-player').value = '';
            document.getElementById('tp-x').value = '';
            document.getElementById('tp-y').value = '';
            document.getElementById('tp-z').value = '';
        } else {
            showMessage('Failed to teleport: ' + data.error, false);
        }
    });
}

function giveItem() {
    const player = document.getElementById('give-player').value.trim();
    const item = document.getElementById('give-item').value.trim();
    const amount = document.getElementById('give-amount').value;

    if (!player || !item) {
        showMessage('Please enter player name and item', false);
        return;
    }

    fetch('/api/player/give', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ player: player, item: item, amount: parseInt(amount) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(`Gave ${amount} ${item} to ${player}`, true);
            document.getElementById('give-player').value = '';
            document.getElementById('give-item').value = '';
            document.getElementById('give-amount').value = '1';
        } else {
            showMessage('Failed to give item: ' + data.error, false);
        }
    });
}

function changeGamemode() {
    const player = document.getElementById('gamemode-player').value.trim();
    const gamemode = document.getElementById('gamemode-select').value;

    if (!player) {
        showMessage('Please enter a player name', false);
        return;
    }

    fetch('/api/player/gamemode', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ player: player, gamemode: gamemode })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(`Changed ${player}'s gamemode to ${gamemode}`, true);
            document.getElementById('gamemode-player').value = '';
        } else {
            showMessage('Failed to change gamemode: ' + data.error, false);
        }
    });
}

function giveEffect() {
    const player = document.getElementById('effect-player').value.trim();
    const effect = document.getElementById('effect-type').value;
    const duration = document.getElementById('effect-duration').value;

    if (!player) {
        showMessage('Please enter a player name', false);
        return;
    }

    fetch('/api/player/effect', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ player: player, effect: effect, duration: parseInt(duration) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(`Gave ${effect} to ${player} for ${duration}s`, true);
            document.getElementById('effect-player').value = '';
        } else {
            showMessage('Failed to give effect: ' + data.error, false);
        }
    });
}

// Welcome Kit Functions
function toggleMapConfig() {
    const mapCheckbox = document.getElementById('kit-map');
    const mapConfig = document.getElementById('map-config');
    mapConfig.style.display = mapCheckbox.checked ? 'block' : 'none';
}

function updateItemSections() {
    console.log('[updateItemSections] Called');
    const selectedGrid = document.getElementById('selected-items-grid');
    const availableGrid = document.getElementById('available-items-grid');

    if (!selectedGrid || !availableGrid) {
        console.error('[updateItemSections] Could not find grids');
        return;
    }

    // Get all item labels - convert to array to avoid live collection issues
    const allLabels = Array.from(document.querySelectorAll('.kit-item-label'));
    console.log('[updateItemSections] Found', allLabels.length, 'labels');

    // Clear both sections
    selectedGrid.innerHTML = '';
    availableGrid.innerHTML = '';

    let selectedCount = 0;
    let availableCount = 0;

    // Sort items into selected vs available - MOVE elements, don't clone
    allLabels.forEach(label => {
        const checkbox = label.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) {
            // Move to selected section
            selectedGrid.appendChild(label);
            selectedCount++;
        } else {
            // Move to available section
            availableGrid.appendChild(label);
            availableCount++;
        }
    });

    console.log('[updateItemSections] Selected:', selectedCount, 'Available:', availableCount);

    // Update map config visibility
    toggleMapConfig();
}

function setupWelcomeKit() {
    // Item mapping: checkbox ID -> [minecraft_item_name, amount]
    const itemMap = {
        'kit-compass': ['compass', 1],
        'kit-bread': ['bread', 10],
        'kit-apple': ['apple', 5],
        'kit-wooden-pickaxe': ['wooden_pickaxe', 1],
        'kit-wooden-axe': ['wooden_axe', 1],
        'kit-wooden-sword': ['wooden_sword', 1],
        'kit-oak-log': ['oak_log', 16],
        'kit-cobblestone': ['cobblestone', 32],
        'kit-torch': ['torch', 16],
        'kit-bed': ['bed', 1],
        'kit-crafting-table': ['crafting_table', 1],
        'kit-chest': ['chest', 1]
    };

    // Collect checked items
    const selectedItems = [];

    // Handle map separately with zoom level
    const mapCheckbox = document.getElementById('kit-map');
    if (mapCheckbox && mapCheckbox.checked) {
        const mapType = document.getElementById('map-type').value;
        const zoomLevel = document.getElementById('map-zoom').value;
        // Bedrock accepts: give @p filled_map 1 <zoom_level>
        selectedItems.push(`${mapType} 1 ${zoomLevel}`);
    }

    for (const [checkboxId, itemData] of Object.entries(itemMap)) {
        const checkbox = document.getElementById(checkboxId);
        if (checkbox && checkbox.checked) {
            selectedItems.push(`${itemData[0]} ${itemData[1]}`);
        }
    }

    if (selectedItems.length === 0) {
        showWelcomeKitStatus('Please select at least one item', false);
        return;
    }

    showWelcomeKitStatus('Setting up welcome kit...', true);

    // Join items with newlines for the backend
    const itemsText = selectedItems.join('\n');

    console.log('Sending items:', itemsText);

    fetch('/api/welcome-kit/setup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: itemsText })
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            showWelcomeKitStatus(`âœ“ Welcome kit enabled with ${selectedItems.length} items! New players will receive them automatically.`, true);
            checkWelcomeKitStatus();  // Update the badge
        } else {
            showWelcomeKitStatus('âœ— Failed: ' + (data.error || 'Unknown error'), false);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showWelcomeKitStatus('âœ— Error: ' + error.message, false);
    });
}

function disableWelcomeKit() {
    fetch('/api/welcome-kit/disable', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showWelcomeKitStatus('âœ“ Welcome kit disabled', true);
            checkWelcomeKitStatus();  // Update the badge
        } else {
            showWelcomeKitStatus('âœ— Failed to disable: ' + data.error, false);
        }
    });
}

function checkWelcomeKitStatus() {
    fetch('/api/welcome-kit/status')
        .then(response => response.json())
        .then(data => {
            const badge = document.getElementById('kit-status-badge');
            const enableButton = document.querySelector('button[onclick="setupWelcomeKit()"]');

            if (data.enabled) {
                badge.textContent = 'âœ“ ENABLED';
                badge.style.background = '#4CAF50';
                badge.style.color = '#fff';

                // Change button text to "Update" when kit is enabled
                if (enableButton) {
                    enableButton.innerHTML = 'ğŸ”„ Update Welcome Kit';
                }

                // Show items if available
                if (data.items && data.items.length > 0) {
                    badge.title = 'Items: ' + data.items.join(', ');

                    // Restore checkbox states based on active kit
                    restoreCheckboxStates(data.items, data.map_zoom);
                }
            } else {
                badge.textContent = 'DISABLED';
                badge.style.background = '#555';
                badge.style.color = '#aaa';
                badge.title = '';

                // Reset button text to "Enable" when kit is disabled
                if (enableButton) {
                    enableButton.innerHTML = 'âœ“ Enable Welcome Kit';
                }
            }
        })
        .catch(error => {
            console.error('Error checking welcome kit status:', error);
            const badge = document.getElementById('kit-status-badge');
            badge.textContent = 'ERROR';
            badge.style.background = '#f44336';
            badge.style.color = '#fff';
        });
}

function restoreCheckboxStates(activeItems, mapZoom) {
    console.log('[Welcome Kit] Restoring checkbox states for items:', activeItems);
    console.log('[Welcome Kit] Map zoom level:', mapZoom);

    // Parse active items (format: "item_name xAmount")
    const activeItemNames = activeItems.map(item => {
        const parts = item.split(' ');
        return parts[0]; // Get just the item name
    });

    console.log('[Welcome Kit] Parsed item names:', activeItemNames);

    // Map of checkbox IDs to item names - MUST match exactly what the API returns
    const checkboxMap = {
        'kit-map': 'filled_map',
        'kit-compass': 'compass',
        'kit-bread': 'bread',
        'kit-apple': 'apple',
        'kit-wooden-pickaxe': 'wooden_pickaxe',
        'kit-wooden-axe': 'wooden_axe',
        'kit-wooden-sword': 'wooden_sword',
        'kit-oak-log': 'oak_log',
        'kit-cobblestone': 'cobblestone',
        'kit-torch': 'torch',
        'kit-bed': 'bed',
        'kit-crafting-table': 'crafting_table',
        'kit-chest': 'chest'
    };

    // First, uncheck all checkboxes
    for (const checkboxId in checkboxMap) {
        const checkbox = document.getElementById(checkboxId);
        if (checkbox) {
            checkbox.checked = false;
        }
    }

    // Then check only the active items
    for (const checkboxId in checkboxMap) {
        const itemName = checkboxMap[checkboxId];
        const checkbox = document.getElementById(checkboxId);
        if (checkbox && activeItemNames.includes(itemName)) {
            console.log('[Welcome Kit] Checking checkbox:', checkboxId, 'for item:', itemName);
            checkbox.checked = true;
        }
    }

    // Restore map zoom level if present
    if (mapZoom !== null && mapZoom !== undefined) {
        const zoomSlider = document.getElementById('map-zoom');
        const zoomValue = document.getElementById('zoom-value');
        if (zoomSlider && zoomValue) {
            zoomSlider.value = mapZoom;
            zoomValue.textContent = mapZoom;
            console.log('[Welcome Kit] Restored map zoom to:', mapZoom);
        }
    }

    console.log('[Welcome Kit] Checkbox restoration complete');

    // Update item sections to move checked items to selected area
    updateItemSections();
}

function showWelcomeKitStatus(msg, success) {
    const statusDiv = document.getElementById('welcome-kit-status');
    statusDiv.style.display = 'block';
    statusDiv.style.backgroundColor = success ? '#7cbd1e' : '#ff5555';
    statusDiv.style.color = success ? '#000' : '#fff';
    statusDiv.textContent = msg;

    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 8000);
}

// Load on page load
loadOnlinePlayers();
loadOps();
checkWelcomeKitStatus();
updateItemSections();  // Initialize item sections (also calls toggleMapConfig)

// Auto-refresh every 10 seconds
setInterval(loadOnlinePlayers, 10000);
</script>
{% endblock %}
