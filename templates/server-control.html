{% extends "base.html" %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto;">
    <!-- Server Control -->
    <div class="mc-panel" style="margin-bottom: 20px;">
        <div class="mc-panel-header">
            ğŸ›ï¸ Server Control
        </div>
        <div class="mc-panel-body">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                <div>
                    <h3 style="color: #7cbd1e; margin-top: 0;">Broadcast Message</h3>
                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <input type="text" id="broadcast-message" class="mc-input" placeholder="Message to all players..." style="flex: 1;">
                        <button class="mc-button mc-button-blue" onclick="broadcastMessage()" style="white-space: nowrap;">
                            ğŸ“¢ Broadcast
                        </button>
                    </div>
                    <small style="color: #aaa;">Send a message to all online players</small>
                </div>

                <div>
                    <h3 style="color: #7cbd1e; margin-top: 0;">Title Message</h3>
                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <input type="text" id="title-message" class="mc-input" placeholder="Title text..." style="flex: 1;">
                        <button class="mc-button mc-button-green" onclick="sendTitle()" style="white-space: nowrap;">
                            ğŸ“º Send Title
                        </button>
                    </div>
                    <small style="color: #aaa;">Display a title on all players' screens</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Banned Players -->
    <div class="mc-panel" style="margin-bottom: 20px;">
        <div class="mc-panel-header">
            ğŸš« Banned Players
        </div>
        <div class="mc-panel-body">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <h3 style="color: #7cbd1e; margin-top: 0;">Ban Player</h3>
                    <input type="text" id="ban-player-name" class="mc-input" placeholder="Player name" style="margin-bottom: 8px;">
                    <textarea id="ban-reason" class="mc-input" placeholder="Reason for ban (optional)" rows="2" style="margin-bottom: 8px; resize: vertical;"></textarea>
                    <button class="mc-button mc-button-red" onclick="banPlayer()" style="width: 100%;">
                        ğŸš« Ban Player
                    </button>
                </div>

                <div>
                    <h3 style="color: #7cbd1e; margin-top: 0;">Unban Player</h3>
                    <input type="text" id="unban-player-name" class="mc-input" placeholder="Player name" style="margin-bottom: 8px;">
                    <button class="mc-button mc-button-green" onclick="unbanPlayer()" style="width: 100%; margin-top: 42px;">
                        âœ“ Unban Player
                    </button>
                </div>
            </div>

            <div id="banned-list" style="margin-top: 20px;">
                <h3 style="color: #7cbd1e;">Currently Banned</h3>
                <div id="banned-players" style="background: #555; padding: 16px; border-radius: 4px; min-height: 100px;">
                    <p style="color: #aaa; text-align: center;">Loading banned players...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup Management -->
    <div class="mc-panel" style="margin-bottom: 20px;">
        <div class="mc-panel-header">
            ğŸ’¾ World Backups
        </div>
        <div class="mc-panel-body">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <h3 style="color: #7cbd1e; margin-top: 0;">Create Backup</h3>
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        <input type="text" id="backup-name" class="mc-input" placeholder="Backup name (optional)" style="flex: 1;">
                        <button class="mc-button mc-button-green" onclick="createBackup()" style="white-space: nowrap;">
                            ğŸ’¾ Create
                        </button>
                    </div>
                    <small style="color: #aaa;">Leave name blank for auto-generated timestamp</small>
                </div>

                <div>
                    <h3 style="color: #ff9900; margin-top: 0;">Restore Backup</h3>
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        <select id="backup-select" class="mc-input" style="flex: 1;">
                            <option value="">Loading backups...</option>
                        </select>
                        <button class="mc-button mc-button-blue" onclick="restoreBackup()" style="white-space: nowrap;">
                            â†©ï¸ Restore
                        </button>
                    </div>
                    <small style="color: #aaa;">âš ï¸ Current world will be replaced</small>
                </div>
            </div>

            <div style="margin-top: 16px; padding: 12px; background: #555; border-radius: 4px;">
                <small style="color: #aaa;">
                    View all backups, delete old ones, or create new worlds in the <a href="/worlds" style="color: #7cbd1e;">Worlds</a> page.
                </small>
            </div>
        </div>
    </div>

    <!-- Server Actions -->
    <div class="mc-panel">
        <div class="mc-panel-header">
            âš ï¸ Server Actions
        </div>
        <div class="mc-panel-body">
            <div class="grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                <div>
                    <h3 style="color: #7cbd1e; margin-top: 0;">Save World</h3>
                    <button class="mc-button mc-button-green" onclick="saveWorld()" style="width: 100%;">
                        ğŸ’¾ Save All
                    </button>
                    <small style="color: #aaa; display: block; margin-top: 8px;">Force save world data</small>
                </div>

                <div>
                    <h3 style="color: #ff9900; margin-top: 0;">Restart Server</h3>
                    <button class="mc-button mc-button-blue" onclick="restartServer()" style="width: 100%;">
                        ğŸ”„ Restart
                    </button>
                    <small style="color: #aaa; display: block; margin-top: 8px;">Restart the Minecraft server</small>
                </div>

                <div>
                    <h3 style="color: #55ff55; margin-top: 0;">Start Server</h3>
                    <button class="mc-button mc-button-green" onclick="startServer()" style="width: 100%;">
                        â–¶ï¸ Start
                    </button>
                    <small style="color: #aaa; display: block; margin-top: 8px;">Start the server if stopped</small>
                </div>

                <div>
                    <h3 style="color: #ff5555; margin-top: 0;">Stop Server</h3>
                    <button class="mc-button mc-button-red" onclick="stopServer()" style="width: 100%;">
                        â¹ï¸ Stop
                    </button>
                    <small style="color: #aaa; display: block; margin-top: 8px;">Stop the server (manual start required)</small>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <h3 style="color: #55aaff;">Update Server</h3>
                <p style="color: #aaa; margin-bottom: 10px;" id="server-version">Current version: Loading...</p>
                <button class="mc-button" onclick="updateServer()" style="width: 100%; background: #5555ff;">
                    â¬†ï¸ Check for Updates & Install
                </button>
                <small style="color: #aaa; display: block; margin-top: 8px;">Pull latest Bedrock server version and restart</small>
            </div>

            <div style="margin-top: 20px; padding: 16px; background: #ffcc00; border: 2px solid #ff9900; border-radius: 4px;">
                <p style="color: #000; margin: 0; font-weight: bold;">âš ï¸ Warning: Restart, Stop, and Update actions will disconnect all players!</p>
            </div>
        </div>
    </div>
</div>

<div id="message-box" style="position: fixed; top: 20px; right: 20px; max-width: 400px; display: none; z-index: 9999;"></div>
{% endblock %}

{% block extra_js %}
<script>
function showMessage(message, success = true) {
    const msgBox = document.getElementById('message-box');
    msgBox.style.display = 'block';
    msgBox.style.padding = '16px';
    msgBox.style.borderRadius = '4px';
    msgBox.style.border = '4px solid';
    msgBox.style.backgroundColor = success ? '#7cbd1e' : '#ff5555';
    msgBox.style.borderColor = success ? '#5a8c2a' : '#cc0000';
    msgBox.style.color = '#fff';
    msgBox.style.fontFamily = 'VT323, monospace';
    msgBox.style.fontSize = '20px';
    msgBox.textContent = message;
    msgBox.style.textShadow = '2px 2px 0 #000';

    setTimeout(() => {
        msgBox.style.display = 'none';
    }, 4000);
}

function broadcastMessage() {
    const message = document.getElementById('broadcast-message').value.trim();
    if (!message) {
        showMessage('Please enter a message', false);
        return;
    }

    fetch('/api/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ command: `say ${message}` })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('âœ“ Message broadcasted!', true);
            document.getElementById('broadcast-message').value = '';
        } else {
            showMessage('âœ— Failed to broadcast', false);
        }
    });
}

function sendTitle() {
    const title = document.getElementById('title-message').value.trim();
    if (!title) {
        showMessage('Please enter a title', false);
        return;
    }

    fetch('/api/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ command: `title @a title ${title}` })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('âœ“ Title sent!', true);
            document.getElementById('title-message').value = '';
        } else {
            showMessage('âœ— Failed to send title', false);
        }
    });
}

function banPlayer() {
    const playerName = document.getElementById('ban-player-name').value.trim();
    const reason = document.getElementById('ban-reason').value.trim();

    if (!playerName) {
        showMessage('Please enter a player name', false);
        return;
    }

    if (!confirm(`Are you sure you want to ban ${playerName}?`)) {
        return;
    }

    const command = reason ? `ban "${playerName}" ${reason}` : `ban "${playerName}"`;

    fetch('/api/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ command: command })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(`âœ“ Banned ${playerName}`, true);
            document.getElementById('ban-player-name').value = '';
            document.getElementById('ban-reason').value = '';
            loadBannedPlayers();
        } else {
            showMessage(`âœ— Failed to ban ${playerName}`, false);
        }
    });
}

function unbanPlayer() {
    const playerName = document.getElementById('unban-player-name').value.trim();

    if (!playerName) {
        showMessage('Please enter a player name', false);
        return;
    }

    fetch('/api/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ command: `pardon "${playerName}"` })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(`âœ“ Unbanned ${playerName}`, true);
            document.getElementById('unban-player-name').value = '';
            loadBannedPlayers();
        } else {
            showMessage(`âœ— Failed to unban ${playerName}`, false);
        }
    });
}

function loadBannedPlayers() {
    // Note: Bedrock doesn't have a direct way to list banned players via RCON
    // This would need to read the banned-players.json file
    document.getElementById('banned-players').innerHTML =
        '<p style="color: #aaa; text-align: center;">Banned player list requires file access.<br>Use unban command above to pardon players.</p>';
}

function loadBackupList() {
    fetch('/api/backups')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('backup-select');

            if (data.success && data.backups && data.backups.length > 0) {
                select.innerHTML = '<option value="">Select a backup...</option>';
                data.backups.forEach(backup => {
                    const option = document.createElement('option');
                    option.value = backup.filename;
                    option.textContent = `${backup.filename} (${backup.date})`;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">No backups available</option>';
            }
        })
        .catch(error => {
            const select = document.getElementById('backup-select');
            select.innerHTML = '<option value="">Error loading backups</option>';
            console.error('Failed to load backups:', error);
        });
}

function createBackup() {
    const backupName = document.getElementById('backup-name').value.trim();

    if (!confirm('Create a backup of the current world?\n\nThis may take a few moments depending on world size.')) {
        return;
    }

    // First save the world
    fetch('/api/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ command: 'save-all' })
    })
    .then(() => {
        // Wait a moment for save to complete
        return new Promise(resolve => setTimeout(resolve, 2000));
    })
    .then(() => {
        // Create the backup
        return fetch('/api/backup/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: backupName || undefined })
        });
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(`âœ“ Backup created: ${data.filename || 'success'}`, true);
            document.getElementById('backup-name').value = '';
            loadBackupList(); // Refresh the backup list
        } else {
            showMessage('âœ— Failed to create backup: ' + (data.error || 'Unknown error'), false);
        }
    })
    .catch(error => {
        showMessage('âœ— Error: ' + error, false);
    });
}

function restoreBackup() {
    const select = document.getElementById('backup-select');
    const backupFilename = select.value;

    if (!backupFilename) {
        showMessage('Please select a backup to restore', false);
        return;
    }

    if (!confirm(`âš ï¸ RESTORE BACKUP?\n\nThis will:\n1. Replace your current world with: ${backupFilename}\n2. All changes since this backup will be LOST\n3. Server must be restarted after restore\n\nAre you SURE you want to continue?`)) {
        return;
    }

    // Double confirmation for safety
    if (!confirm('Final confirmation: Restore this backup and lose all current progress?')) {
        return;
    }

    fetch('/api/backup/restore', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: backupFilename })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('âœ“ Backup restored! Restart server to load.', true);
        } else {
            showMessage('âœ— Failed to restore backup: ' + (data.error || 'Unknown error'), false);
        }
    })
    .catch(error => {
        showMessage('âœ— Error: ' + error, false);
    });
}

function saveWorld() {
    if (!confirm('Save the world now?')) {
        return;
    }

    fetch('/api/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ command: 'save-all' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('âœ“ World saved successfully!', true);
        } else {
            showMessage('âœ— Failed to save world', false);
        }
    });
}

function restartServer() {
    if (!confirm('âš ï¸ RESTART SERVER?\n\nThis will disconnect all players and restart the server.\n\nAre you sure?')) {
        return;
    }

    // Warn players first
    fetch('/api/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ command: 'say Server restarting in 10 seconds!' })
    });

    setTimeout(() => {
        fetch('/api/server/restart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('âœ“ Server restart initiated', true);
            } else {
                showMessage('âœ— Failed to restart: ' + (data.error || 'Unknown error'), false);
            }
        })
        .catch(error => {
            showMessage('âœ— Error: ' + error, false);
        });
    }, 10000);
}

function stopServer() {
    if (!confirm('âš ï¸ STOP SERVER?\n\nThis will disconnect all players and STOP the server.\nYou will need to manually start it again.\n\nAre you ABSOLUTELY sure?')) {
        return;
    }

    // Double confirmation
    if (!confirm('Final confirmation: Stop the server now?')) {
        return;
    }

    // Warn players first
    fetch('/api/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ command: 'say Server stopping in 10 seconds!' })
    });

    setTimeout(() => {
        fetch('/api/server/stop', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('âœ“ Server stop initiated', true);
            } else {
                showMessage('âœ— Failed to stop: ' + (data.error || 'Unknown error'), false);
            }
        })
        .catch(error => {
            showMessage('âœ— Error: ' + error, false);
        });
    }, 10000);
}

function startServer() {
    if (!confirm('Start the Minecraft server?')) {
        return;
    }

    showMessage('Starting server...', true);

    fetch('/api/server/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('âœ“ Server started successfully!', true);
        } else {
            showMessage('âœ— Failed to start: ' + (data.error || 'Unknown error'), false);
        }
    })
    .catch(error => {
        showMessage('âœ— Error: ' + error, false);
    });
}

function updateServer() {
    if (!confirm('âš ï¸ UPDATE SERVER?\n\nThis will:\n1. Save the world\n2. Pull the latest Bedrock server version\n3. Restart the server\n\nAll players will be disconnected.\nThis may take 2-5 minutes.\n\nAre you sure?')) {
        return;
    }

    // Warn players immediately
    fetch('/api/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ command: 'say Server updating NOW! Disconnection imminent.' })
    });

    showMessage('Updating server... This may take 2-5 minutes. Please wait.', true);

    // Disable the button to prevent double-clicks
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'â³ Updating...';

    // Use AbortController for timeout (5 minutes)
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 300000);

    fetch('/api/server/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        signal: controller.signal
    })
    .then(response => response.json())
    .then(data => {
        clearTimeout(timeoutId);
        btn.disabled = false;
        btn.textContent = 'â¬†ï¸ Check for Updates & Install';

        if (data.success) {
            if (data.updated) {
                showMessage('âœ“ Server updated to latest version!', true);
            } else {
                showMessage('âœ“ Server is already up to date', true);
            }
            loadServerVersion();
        } else {
            showMessage('âœ— Update failed: ' + (data.error || 'Unknown error'), false);
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        btn.disabled = false;
        btn.textContent = 'â¬†ï¸ Check for Updates & Install';

        if (error.name === 'AbortError') {
            showMessage('âœ— Update timed out after 5 minutes. Check server status.', false);
        } else {
            showMessage('âœ— Error: ' + error, false);
        }
    });
}

function loadServerVersion() {
    fetch('/api/server/version')
    .then(response => response.json())
    .then(data => {
        const versionEl = document.getElementById('server-version');
        if (data.success && data.version) {
            versionEl.textContent = 'Current version: ' + data.version;
        } else {
            versionEl.textContent = 'Current version: Unknown';
        }
    })
    .catch(() => {
        document.getElementById('server-version').textContent = 'Current version: Unable to fetch';
    });
}

// Load banned players and backup list on page load
loadBannedPlayers();
loadBackupList();
loadServerVersion();
</script>

<style>
@media (max-width: 768px) {
    .grid {
        grid-template-columns: 1fr !important;
    }
}
</style>
{% endblock %}
